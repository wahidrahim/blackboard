// Generated by CoffeeScript 1.10.0
var appendUserDiv, makePath, removePath;

socket.on('load canvas', function(data) {
  $('#connected').text(data.num_users);
  canvas.loadFromJSON(data.canvas_state);
  return data.users.map(function(id) {
    return appendUserDiv(id);
  });
});

socket.on('user connected', function(data) {
  $('#connected').text(data.num_users);
  return appendUserDiv(data.id);
});

socket.on('user move', function(data) {
  return $('#' + data.id).css({
    visibility: 'visible',
    position: 'absolute',
    left: data.x,
    top: data.y,
    width: data.size,
    height: data.size,
    background: data.color
  });
});

socket.on('user disconnected', function(data) {
  $('#connected').text(data.num_users);
  if (data.actions) {
    data.actions.map(function(p) {
      return removePath(p);
    });
    socket.emit('save canvas', canvas.toJSON());
  }
  console.log(data.id);
  return $('#' + data.id).remove();
});

socket.on('add path', function(json_path) {
  return canvas.add(makePath(json_path));
});

socket.on('remove path', function(json_path) {
  return removePath(makePath(json_path));
});

appendUserDiv = function(id) {
  return $('<div>', {
    id: id,
    "class": 'user'
  }).appendTo('body');
};

makePath = function(json_path) {
  var path, svg_d;
  svg_d = json_path.path.toString().split(',').join(' ');
  path = new fabric.Path(svg_d, {
    stroke: json_path.stroke,
    strokeWidth: json_path.strokeWidth,
    fill: null,
    strokeLineCap: 'round',
    strokeLineJoin: 'round',
    pathOffset: {
      x: json_path.pathOffset.x,
      y: json_path.pathOffset.y
    }
  });
  return path;
};

removePath = function(p) {
  return canvas.forEachObject(function(o) {
    var o_path, p_path;
    o_path = o.path.toString();
    p_path = p.path.toString();
    if (o_path === p_path) {
      return o.remove();
    }
  });
};
